<p id="notice"><%= notice %></p>

<p>
  <strong>Name:</strong>
  <%= @chat_room.name %>
</p>

<p>
  <strong>Channel:</strong>
  <%= @chat_room.channel %>
</p>

<div id="chat-room-messages">
	<h3> 訊息 </h3>
	<table>
		<tbody>
			<% @letters.each do |letter| %>
				<tr>
					<td> <%= letter.content %> </td>
					<td> <%= letter.created_at.strftime('%m/%d %X') %> </td>
					<td> <%= letter.username %> </td>
				</tr>
			<% end %>
		</tbody>
	</table>
	<hr>
	<%= form_for @chat_room.letters.new, :url=>chat_room_letters_path(@chat_room), :remote=>true do |form| %>
		<%= form.text_field :content %>
		<%= form.submit "送出" %>
	<% end %>
</div>

<%= link_to '離開', chat_rooms_path, :class=>"leave" %>

<script type="text/javascript">
		
	function item(content,created_at,username){
		return (
			'<tr><td> ' + content + '</td><td>' + created_at + '</td><td>' + username + '</td></tr>'
			)
	}

	function checkNumber(){
		if ($('#chat-room-messages table tbody').find($('tr')).length >10 ){
			$($('#chat-room-messages table tbody').find($('tr'))[0]).remove();
		}
	}


	$(document).ready(function(){
		var faye = new Faye.Client('<%= request.protocol + request.host %>:3000/faye')
		subscription = faye.subscribe("/message/<%=@chat_room.channel%>",function(payload){
			$('#chat-room-messages table tbody').append(item(payload['content'],payload['created_at'],payload['username']));
			checkNumber();
		})		

		$('.leave').click(function(e){
			subscription.cancel();
		})
	})

</script>


